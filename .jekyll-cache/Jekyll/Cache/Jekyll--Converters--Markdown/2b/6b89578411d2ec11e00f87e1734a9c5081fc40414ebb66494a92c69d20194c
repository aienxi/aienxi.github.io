I"„#<h3 id="è®¾ç½®åå°æ’­æ”¾">è®¾ç½®åå°æ’­æ”¾</h3>
<h4 id="1åœ¨signing--capabilitiesä¸­è®¾-backgroud-modesæŒ‰éœ€æ·»åŠ ">1.åœ¨Signing &amp; Capabilitiesä¸­è®¾ backgroud modesæŒ‰éœ€æ·»åŠ </h4>

<div class="language-css highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">backgroud</span> <span class="nt">modes</span>
<span class="nt">App</span> <span class="nt">plays</span> <span class="nt">audio</span> <span class="nt">or</span> <span class="nt">streams</span> <span class="nt">audio</span><span class="o">/</span><span class="nt">video</span> <span class="nt">using</span> <span class="nt">AirPlay</span>
<span class="nt">App</span> <span class="nt">downloads</span> <span class="nt">content</span> <span class="nt">from</span> <span class="nt">the</span> <span class="nt">network</span>
<span class="nt">App</span> <span class="nt">downloads</span> <span class="nt">content</span> <span class="nt">in</span> <span class="nt">response</span> <span class="nt">to</span> <span class="nt">push</span> <span class="nt">notifications</span>
</code></pre></div></div>
<h4 id="2æ¿€æ´»éŸ³é¢‘ä¼šè¯">2.æ¿€æ´»éŸ³é¢‘ä¼šè¯</h4>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    // è®¾ç½®åå°æ’­æ”¾çš„ä»£ç ,æ­¥éª¤
    // 1.è·å–éŸ³é¢‘çš„ä¼šè¯
    AVAudioSession *session = [AVAudioSession sharedInstance];
    // 2.è®¾ç½®åå°æ’­æ”¾ç±»å‹
    [session setCategory:AVAudioSessionCategoryPlayback error:nil];
    // 3.æ¿€æ´»ä¼šè¯
    [session setActive:YES error:nil];

</code></pre></div></div>
<h4 id="æ’­æ”¾è½¨é“å˜åŒ–é€šçŸ¥-è¿æ¥è€³æœº-éŸ³ç®±ç­‰æ’æ‹”è€³æœºéŸ³é¢‘è¢«æ‰“æ–­äº‹ä»¶é…ç½®è¿œç¨‹æ§åˆ¶æ˜¾ç¤ºçš„ä¿¡æ¯è€³æœºçº¿æ§">æ’­æ”¾è½¨é“å˜åŒ–é€šçŸ¥ ï¼ˆè¿æ¥è€³æœº éŸ³ç®±ç­‰ï¼‰ã€æ’æ‹”è€³æœºã€éŸ³é¢‘è¢«æ‰“æ–­äº‹ä»¶ã€é…ç½®è¿œç¨‹æ§åˆ¶æ˜¾ç¤ºçš„ä¿¡æ¯ï¼ˆè€³æœºçº¿æ§ï¼‰</h4>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-(void)afterInit{

    ///é…ç½®è¿œç¨‹æ§åˆ¶æ˜¾ç¤ºçš„ä¿¡æ¯
    [[UIApplication sharedApplication]
    beginReceivingRemoteControlEvents];
    [self configRemoteCommandCenter];

//  æ’æ‹”è€³æœº
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(audioRouteChangeListenerCallback:)   name:AVAudioSessionRouteChangeNotification object:nil];
//  éŸ³é¢‘è¢«æ‰“æ–­äº‹ä»¶
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(audioBreakEvent:) name:AVAudioSessionInterruptionNotification object:nil];
//  åº”ç”¨ç¨‹åºè¿›å…¥å‰å°
    [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(appDidBecomeActive) name:UIApplicationDidBecomeActiveNotification object:nil];

}        
#pragma mark -   æ’æ‹”è€³æœº
- (void)audioRouteChangeListenerCallback:(NSNotification*)notification{
    NSDictionary *interuptionDict = notification.userInfo;
    DLog(@"%@",interuptionDict);
    NSInteger routeChangeReason = [[interuptionDict valueForKey:AVAudioSessionRouteChangeReasonKey] integerValue];
    switch (routeChangeReason) {
        case AVAudioSessionRouteChangeReasonNewDeviceAvailable:
            DLog(@"è€³æœºæ’å…¥");
            break;
        case AVAudioSessionRouteChangeReasonOldDeviceUnavailable:
        {
            DLog(@"è€³æœºæ‹”å‡ºï¼Œåœæ­¢æ’­æ”¾æ“ä½œ");
            dispatch_async(dispatch_get_main_queue(), ^{
                [self pause];
            });

        }
            break;
        case AVAudioSessionRouteChangeReasonCategoryChange:
            DLog(@"AVAudioSessionRouteChangeReasonCategoryChange");
            DLog(@"AVAudioSession category = %@",[AVAudioSession sharedInstance].category);
            break;
    }
}
#pragma mark - éŸ³é¢‘è¢«æ‰“æ–­äº‹ä»¶
- (void)audioBreakEvent:(NSNotification*)notification{
    DLog(@"audioBreakEvent");
        NSDictionary *interuptionDict = notification.userInfo;
        NSInteger state = [[interuptionDict objectForKey:@"AVAudioSessionInterruptionTypeKey"] integerValue];
        if (state == 1) {
        //å½“AudioSessionè¢«æŠ¢æ—¶ï¼Œè‹¥æˆ‘ä»¬çš„APPæ­¤æ—¶æ­£åœ¨æ’­æ”¾éŸ³é¢‘ï¼Œæš‚åœæ’­æ”¾ï¼Œå¹¶ä¸”æ ‡è®°ä¸‹éŸ³é¢‘æ˜¯è¢«æ‰“æ–­çš„
            if (self.isAudioActivity) {
                _breadType = 1;
                [self pause];
            }
        }else{
        //å½“å¤ºå›éŸ³é¢‘ç„¦ç‚¹æ—¶è‹¥éŸ³é¢‘æ˜¯è¢«æ‰“æ–­çš„ï¼Œåˆ™å›æ¢å¤æ’­æ”¾
            if (_breadType == 1) {
                _breadType = 0;
                [self resume];
            }
        }
        DLog(@"%@",interuptionDict);
}
- (void)appDidBecomeActive{
    //å½“appDidBecomeActiveæ—¶ï¼Œå°†éŸ³é¢‘æ ‡è®°ä¸ºä¸æ˜¯è¢«æ‰“æ–­çš„ã€‚
    //éŸ³é¢‘ç„¦ç‚¹è¢«æŠ¢æ—¶ï¼Œå¯èƒ½ä¸ä¼šç«‹å³æ”¶åˆ°å¤ºå›éŸ³é¢‘ç„¦ç‚¹çš„å›è°ƒï¼Œè€Œæ˜¯åœ¨APPè¿›å…¥å‰å°æ—¶ï¼Œæ”¶åˆ°é€šçŸ¥ï¼Œè¿™æ—¶å¦‚å†ç»§ç»­æ’­æ”¾ï¼Œä½“éªŒä¸å¥½ã€‚æ‰€ä»¥è¿™ä¸ªæ—¶å€™å°±ä¸å†æ¢å¤æ’­æ”¾äº†ã€‚
    _breadType = 0;
}
#pragma mark - è¿œç¨‹æ§åˆ¶é…ç½® è€³æœºçº¿æ§
- (void) configRemoteCommandCenter
{
    WeakSelf

    MPRemoteCommandCenter *remoteCommandCenter =  [MPRemoteCommandCenter sharedCommandCenter];
    //    ä¸Šä¸€æ›²æŒ‰é’®
    MPRemoteCommand *previousTrackCommand = remoteCommandCenter.previousTrackCommand;
    previousTrackCommand.enabled = YES;
    [previousTrackCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        [weakSelf playPre];
        return MPRemoteCommandHandlerStatusSuccess;
    }];
    //    ä¸‹ä¸€æ›²æŒ‰é’®
    MPRemoteCommand *nextTrackCommand = remoteCommandCenter.nextTrackCommand;
    nextTrackCommand.enabled = YES;
    [nextTrackCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        [weakSelf playNext];
        return MPRemoteCommandHandlerStatusSuccess;
    }];

    //    æš‚åœæŒ‰é’® 
    MPRemoteCommand *pauseCommand = remoteCommandCenter.pauseCommand;
    [pauseCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        [weakSelf pause];
        return MPRemoteCommandHandlerStatusSuccess;
    }];
    pauseCommand.enabled = YES;
    //    æ’­æ”¾æŒ‰é’®
    MPRemoteCommand *playCommand = remoteCommandCenter.playCommand;
    playCommand.enabled = YES;
    [playCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        if (self.rate.floatValue == 1) {
            [weakSelf resume];
            return MPRemoteCommandHandlerStatusSuccess;
        }else{
        //å½“åœ¨å€é€Ÿæƒ…å†µä¸‹æ’­æ”¾ï¼Œå‡ºç°ç‚¹å‡»ç‚¹å‡»æš‚åœæŒ‰é’®ä¹Ÿä¼šèµ°åˆ°è¿™ä¸ªå›è°ƒä¸­ï¼Œä¸å‡ é“æ€ä¹ˆå›äº‹
            if (weakSelf.status == AudioPlayStatusPlay) {
                [weakSelf pause];
            }else{
                [weakSelf resume];
            }
        }
        return MPRemoteCommandHandlerStatusSuccess;

    }];

//    æ’­æ”¾è¿›åº¦è°ƒèŠ‚æŒ‰é’®
    MPRemoteCommand *changePlaybackPositionCommand = remoteCommandCenter.changePlaybackPositionCommand;
    changePlaybackPositionCommand.enabled = YES;
    [changePlaybackPositionCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        MPChangePlaybackPositionCommandEvent * playbackPositionEvent = (MPChangePlaybackPositionCommandEvent *)event;
        [weakSelf seekToTime:playbackPositionEvent.positionTime completionHandler:^(BOOL finished) {
            
        }];
        return MPRemoteCommandHandlerStatusSuccess;
    }];
    //    è€³æœºçº¿æ§æŒ‰é’®å•å‡»æ—¶ä¼šè°ƒç”¨
    MPRemoteCommand *togglePlayPauseCommand = remoteCommandCenter.togglePlayPauseCommand;
    togglePlayPauseCommand.enabled = YES;
    [togglePlayPauseCommand addTargetWithHandler:^MPRemoteCommandHandlerStatus(MPRemoteCommandEvent * _Nonnull event) {
        if (weakSelf.status == AudioPlayStatusPlay) {
            [weakSelf pause];
        }else{
            [weakSelf resume];
        }
        return 0;
    }];
    
}
#pragma mark - æ¥ç”µè¯å¤„ç†
- (void)handleCall{
    WeakSelf
    self.callCenter = [[CTCallCenter alloc] init];
    self.callCenter.callEventHandler = ^(CTCall* call) {
        if ([call.callState isEqualToString:CTCallStateDisconnected]){
            DLog(@"æŒ‚æ–­ç”µè¯Call has been disconnected");
            if (_beforeCallIsPlaying == AudioPlayStatusPlay) {
                [weakSelf resume];
            }
        }else if ([call.callState isEqualToString:CTCallStateConnected]){
            DLog(@"ç”µè¯é€šäº†Call has just been connected");
        }else if([call.callState isEqualToString:CTCallStateIncoming]){
            DLog(@"æ¥ç”µè¯äº†Call is incoming");
            _beforeCallIsPlaying = weakSelf.status;
            if (_beforeCallIsPlaying == AudioPlayStatusPlay) {
                [weakSelf pause];
            }
        } else if ([call.callState isEqualToString:CTCallStateDialing]){
            DLog(@"æ­£åœ¨æ‹¨å‡ºç”µè¯call is dialing");
            _beforeCallIsPlaying = weakSelf.status;
            if (_beforeCallIsPlaying == AudioPlayStatusPlay) {
                [weakSelf pause];
            }
        }else{
            DLog(@"ä»€ä¹ˆæ²¡åšNothing is done");
        }
    };

}


</code></pre></div></div>

:ET